#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <unistd.h>

// Example AArch64 shellcode: exit(42)
unsigned char shellcode[] = {
    {{shellcode}}
};

int main() {
    size_t size = sizeof(shellcode);
    size_t pagesize = sysconf(_SC_PAGESIZE);

    // Align size to page size
    size_t alloc_size = (size + pagesize - 1) & ~(pagesize - 1);

    // mmap as RW only
    void *mem = mmap(NULL, alloc_size,
                     PROT_READ | PROT_WRITE,
                     MAP_PRIVATE | MAP_ANONYMOUS,
                     -1, 0);
    if (mem == MAP_FAILED) {
        perror("mmap");
        return 1;
    }

    // Copy shellcode into memory
    memcpy(mem, shellcode, size);

    // Change protection to RX
    if (mprotect(mem, alloc_size, PROT_READ | PROT_EXEC) != 0) {
        perror("mprotect");
        return 1;
    }

    // Call the shellcode
    void (*func)() = mem;
    func();

    // Should not reach here
    puts("Shellcode returned");
    return 0;
}
