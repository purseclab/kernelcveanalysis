# APEX
Some system servers load libraries from apex file (ie. netd loading dns resolver library).
APEX is like APK for system binaries. Has signature, manifest, and ext4 image which is mounted as loopback.

# System Servers

### netd
Handles low level networking and such, loads dns resolver library as well.
Runs with decently high privileges, including root on cuttlefish, though this is not typical.

### system_server
Runs almost all java servers in 1 process
Some services in `system_server`:
- activity manager (`am`): coordinates sending intents and luanching activities and such
- package manager (`pm`): installs apks and such, also does permission checks
	- permission manager has its own binder interface I think

### servicemanager
A native process started early in boot. This is the binder context manager.
Holds mappings between strings to binder handles.
So when app does `ServiceManager.getService(String service_name)` it goes through service manager.

### zygote
Spawns new apps and higher level system services. Has a unix socket in `/dev/socket/zygote` which activity manager talks too.

# IPC
Most app components are started with an intent. You can bind to an app service and get an IBinder which makes ipc method calls with binder.
Binder instances can also be obtained through `servicemanager`.

It is possible to IPC call into the same process, in which case no binder call is performed, and the current thread simply runs the called function.

### Intents
https://developer.android.com/guide/components/intents-filters

### Impementing IPC
- Server
	- Write AIDL interface
	- create an instance of a stub class which is generated by aidl compiler, and override the necessary methods
	- Extend Service (service activity class) and overide onBind to have it return the stub class when onBind is called (stub is an IBinder)
- Client
	- When client starts activity and calls onBind, it gets an IBinder instance referencing the stub
	- The stub has an asInterface method which wraps the IBinder an an object implementing the interface, so now calls are possible

AIDL notes:
mostly just like java interface
There are some restrictions on method types, and also parameters can be marked as in, out, or inout.
Methods can be marked as oneway (only matters for inter process calls), meaning binder driver one way flag is used.

AIDL also supports defining parceleble objects.