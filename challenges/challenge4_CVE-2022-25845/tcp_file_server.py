import argparse
import socket
import os

def send_file_over_tcp(port, filename):
    # Open the file in binary mode
    if not os.path.isfile(filename):
        print(f"Error: File '{filename}' does not exist.")
        return

    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as server_socket:
        # Set SO_REUSEADDR to allow immediate reuse of the port
        server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)

        server_socket.bind(('0.0.0.0', port))
        server_socket.listen(1)
        print(f"Listening on port {port}...")

        conn, addr = server_socket.accept()
        with conn:
            print(f"Connection from {addr}")
            with open(filename, 'rb') as f:
                while True:
                    data = f.read(4096)
                    if not data:
                        break
                    conn.sendall(data)

            print("File sent. Closing connection.")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Send a file over TCP.")
    parser.add_argument("-p", "--port", type=int, required=True, help="Port to listen on.")
    parser.add_argument("file", help="Path to the file to send.")
    args = parser.parse_args()

    send_file_over_tcp(args.port, args.file)
