import uuid
import shutil
from typing import Optional
from pathlib import Path

from deepagents import create_deep_agent
from langgraph.graph.state import CompiledStateGraph
from langchain_core.language_models import BaseChatModel
from langchain_core.tools import BaseTool

from .docker_sandbox import DockerSandbox

def create_kexploit_agent(
    model: str | BaseChatModel,
    system_prompt: str,
    name: str,
    tools: list[BaseTool],
    sandbox: DockerSandbox,
) -> CompiledStateGraph:
    if len(sandbox.mounts) > 0:
        mount_prompt = '\n\nThe following folders may contain relevant data to your task:\n'
        for mount in sandbox.mounts:
            ro_string = '' if mount.writable else ' (read only)'
            mount_prompt += f'{mount.dst_path()}{ro_string}: {mount.description}'
        
        system_prompt += mount_prompt
    
    return create_deep_agent(
        model=model,
        system_prompt=system_prompt,
        tools=tools,
        name=name,
        backend=sandbox,
    )