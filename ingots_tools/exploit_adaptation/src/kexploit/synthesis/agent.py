import uuid
import shutil
from typing import Optional
from pathlib import Path

from deepagents import create_deep_agent
from deepagents.backends.filesystem import FilesystemBackend
from deepagents.backends.protocol import BackendProtocol
from langchain.graph.state import CompiledStateGraph
from langchain_openai import ChatOpenAI

from ..data import llm_workdir
from .lsp import KernelLsp

SYNTHESIS_AGENT_MODEL = 'gpt-5.2'

SYNTHESIS_AGENT_PROMPT = """You are an expert Linux kernel exploit researcher.

Your objective is to analyze a kernel vulnerability and synthesize a working privilege escalation exploit (obtaining root privileges).

Process:
1. Review the provided bug summary and vulnerability details.
2. Formulate a detailed, step-by-step exploitation plan.
3. Utilize the provided LSP tools (Go to definition, Find references, etc.) to explore the kernel codebase. Identify necessary structures, global variables, function addresses, and gadgets.
4. Implement the exploit by filling in the '/exp/exploit.c' template file. This file starts as a placeholder. Your final output must be a compilable C file that executes the attack. Make sure to read the contents of this file before updating it to understand the template and where to write your exploit code.
5. Compile your exploit with '/exp/compile.sh' to produce a binary called 'exploit'. Make sure there are no compilation errors. Modify the '/exp/compile.sh' file as necessary to build the final exploit correctly.

System Information:
{system_specific_info}
"""

ANDROID_SYSTEM_INFO = """Target OS: Android
Architecture: ARM64
Key Mitigations:
- Forward-Edge KCFI (Kernel Control Flow Integrity) is active. Indirect branches are validated.
- ROP (Return-Oriented Programming) is generally not feasible due to KCFI.
- JOP (Jump-Oriented Programming) is heavily restricted.
Constraints:
- Focus on data-only attacks (corrupting credentials, capabilities, or critical data structures) rather than hijacking control flow directly.
"""

class LlmWorkdir:
    '''
    Temporary working directory for llm to utilize.

    Currently saved after completion for human to review.
    '''
    def __init__(self, template_path: Optional[Path] = None):
        self.path = llm_workdir() / str(uuid.uuid4())
        self.path.mkdir(parents=True, exist_ok=True)
        
        if template_path:
            shutil.copytree(template_path, self.path, dirs_exist_ok=True)

        self.backend = FilesystemBackend(root_dir=self.path)

    def __enter__(self) -> FilesystemBackend:
        return self.backend

    def __exit__(self, _exc_type, _exc_val, _exc_tb):
        pass

def create_synthesis_agent(system_prompt: str, lsp: KernelLsp, backend: Optional[BackendProtocol] = None) -> CompiledStateGraph:
    model = ChatOpenAI(
        model=SYNTHESIS_AGENT_MODEL,
        max_tokens=500_000,
        reasoning_effort='high',
    )

    return create_deep_agent(
        model=model,
        # TODO: heap object tools
        tools=lsp.make_llm_tools(),
        system_prompt=system_prompt,
        # TODO: debugger subagent
        # TODO: primitives, either a skill or tool which can search them
        name='kernel exploit researcher',
        backend=backend,
    )