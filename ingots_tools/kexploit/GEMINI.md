# kexploit - Kernel Exploit Adaptation Tool

**kexploit** is a research tool designed to automatically adapt Proof-of-Concept (PoC) exploits between different Linux kernel versions. It leverages LLMs (like GPT-4 or local models via Ollama) to annotate exploit source code and then uses binary analysis (Ghidra, vmlinux-to-elf) to adjust offsets and symbols for target kernels.

## Project Structure

*   **`src/kexploit/`**: The core Python source code for the tool.
    *   `main.py`: Entry point for the CLI (`uv run kexploit`).
    *   `adapt.py`: Logic for adapting exploits (calculating new offsets).
    *   `annotate.py`: Logic for annotating C source code using LLMs.
    *   `ghidra.py`: Interface for Ghidra operations.
    *   `synthesis/`: Folder for experimental exploit synthesis feature.
        *   `__init__.py`: Entry point for synthesis setup, orchestrating BTF extraction and CodeQL analysis.
        *   `btf_types.py`: Classes for parsing and representing Linux kernel BTF (BPF Type Format) types.
        *   `codeql.py`: Interface for running CodeQL queries (allocations, structs) and parsing results.
        *   `location.py`: Utility for handling source code locations and generating unique IDs.
        *   `lsp.py`: Language Server Protocol integration to provide additional information to LLM.
        *   `object_db.py`: SQLite database interface (using SQLAlchemy) for storing kernel objects and allocation sites.
        *   `synthesis_metadata.py`: Manages metadata (paths to artifacts) for synthesis operations.
        *   `agent.py`: Definitions for agents used in exploit synthesis.
*   **`kernelctf_exploits/`**: A collection of exploits targeting `kernelCTF` instances, organized by CVE ID. Contains metadata and documentation.
*   **`src/codeql_queries/`**: CodeQL queries used for the experimental exploit synthesis feature.
*   **`kernelctf_compile.sh`**: Helper script to compile exploits using `nix-shell` for reproducible builds.
*   **`test_exploit.py`**: A `pwntools` script to run and verify compiled exploits against a kernel VM (requires `local_runner.sh`).

## Exploit Synthesis

The exploit synthesis feature will utilise LLMs for exploit synthesis. Currently, the only part being worked on is building a database of heap objects for the kernel, and how to allocate them.
This is done using codeql and linux kernel btf types, and will use dynamic analysis in the future.

## Setup & Dependencies

The project is managed with `uv` (a fast Python package manager).

1.  **Install uv**: [Installation Guide](https://docs.astral.sh/uv/getting-started/installation/)
2.  **Environment Variables**: Create a `.env` file based on the example in `README.md`. Key variables:
    *   `OPENAI_API_KEY`: For LLM-based annotation.
    *   `KEXPLOIT_DATA_DIR`: Directory to store large artifacts (kernels, Ghidra projects).
    *   `GHIDRA_INSTALL_DIR`: Path to a local Ghidra installation (required for analysis).
3.  **External Tools**:
    *   `ghidra` (Release 11.3.2+ recommended)
    *   `vmlinux-to-elf`
    *   `qemu` (for testing)

## Usage

Run commands using `uv run kexploit`.

### Key Commands

*   **Manage Kernels**:
    ```bash
    uv run kexploit kernel add --name <name> <path/to/kernel/image>
    uv run kexploit kernel list
    ```
*   **Annotate Exploit** (Identify offsets in source code):
    ```bash
    uv run kexploit annotate --kernel <kernel_name> exploit.c
    ```
*   **Adapt Exploit** (Port to new kernel):
    ```bash
    uv run kexploit adapt --old-kernel <old_kernel> --new-kernel <new_kernel> exploit.c
    ```
*   **Adapt Project**:
    Reads `kexploit.json` in a project directory to adapt multiple files.
    ```bash
    uv run kexploit adapt-project --new-kernel <new_kernel> --project <path/to/project>
    ```

## Development

*   **Type Checking**: `uv run mypy src`
*   **Docker**: A `Dockerfile` and `set-env` script are provided to run the tool in a containerized environment, which mounts the current directory.

### Style

- Use single quoted strings
- All classes should have their members declared with types at the start of the class definition.
- Imports should be written in the following format
    - Imports from python standard library
    - Imports from 3rd party libraries
    - Imports from files in the kexploit project
    - These 3 categories should have an empty line between them to space them out
- Do not use deprecated python types like List, Dict, etc.
    - Instead use list, dict, etc. directly which do not need imports and are preferred in modern python
