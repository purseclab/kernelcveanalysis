https://googleprojectzero.blogspot.com/2023/09/analyzing-modern-in-wild-android-exploit.html

# Bug
Doing a 32 bit syscall ioctl for alsa with the `SNDRV CTL IOCTL ELEM WRITE` does not acquire a lock, so it can race against `snd_ctl_elem_add` (can be called in another 32 bit ioctl), which frees the `struct snd_kcontrol` if replace field is specified. This leads to `snd_ctl_elem_write` potentially operating on freed `struct snd_kcontrol`.

There is also a feature in mali GPU driver called tistream, used to trace GPU operations. It uses kernal pointer as object identifier, allowing leaks of heap, and KASLR. One tistream object places 16 bytes of user controlled data in memory, and hands back pointer, so 16 bytes can be placed at known address.

# Exploit
No code is available from what I can tell, so this is just rough overview of article:
- Use tistream to leak KASLR
- Unreliable arbitrary write
	- Trigger race, and if it succeeds, `snd_ctl_elem_write` will operate on freed `struct snd_kcontrol` if it locates the object and checks it is not NULL before `snd_ctl_elem_add` frees it
	- Use tistream to place 16 bytes at known location, and fake `elem_data` and `elem_data_size` fields of `struct user_element`
		- Overwrite `private_data` field of `struct snd_kcontrol` in reclaiming process
		- `snd_ctl_elem_write` then writes to where `elem` is pointed
- Reliable arbitrary write
	- Exploit uses unreliable arbitrary write to write in kernel data a fake `struct file_operations` vtable, with a mix of function pointers from different file operations, creating a type confusion
		- This fake vtable is made in kernel uname variable, so it can be monitored when write succeeds
		- read and write of ashmem file operations are replaced with configfs read and write, which read and write to a pointer in file private data
			- ashmem has `ASHMEM_SET_NAME` ioctl which just stores name in this private data, allowing control of pointer which is read and written with
	- Finally, overwrite android shared memory file operations pointer in `ashmem_misc` to point to fake fops
		- Once write succeeds, future opened fds from `/dev/ashmem` will use fake file operations