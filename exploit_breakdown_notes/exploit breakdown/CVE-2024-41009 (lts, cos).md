# Bug
eBPF has something called ringbuffer. eBPF code can push objects into the ringbuffer, and code in userspace can map the ringbuffer, and read the ringbuffer contents, as well as consume ringbuffer objects by adjusting a writable offset representing how much has been consumed. This offset is writable page, the rest is in separate readable pages.

If userspace modifies consumer offset to be partially consuming an object, a new object could be allocated in the ringbuffer, and it can overlap with the old objects header. The header contains an offset to page containing ringbuffer metadata, so this can be overwritten, and trick the kernel to think ringbuf metadata is in the same page that is mapped writable in userspace. Then a malicious metadata with a vtable pointer and rop chain is written, and code execution can be gained.

# Exploit Chain (lts, cos)

### Pin CPU
Pins exploit to CPU 0

### Leak KASLR
Uses CVE-2022-4543 sidechannel to leak KASLR base address.

### Place Coredump String at Fixed Address
Places the string `\/proc/%P/fd/666 %p` at a known address using mmap.
This will later be written to `/proc/sys/kernel/core_pattern` to control program executed on coredump.

### Fork Crashing Process
First this process puts `/proc/self/exe` in memfd 666.
This process waits for `/proc/sys/kernel/corepattern` to be overwritten. Once it is overwritten to a malicious value, this process intentionally segfaults to trigger a coredump, running the attacker process as root.

# Create and Map eBPF Ringbuf
Creates 0x4000 size eBPF ringbuf, dups it into fd 0x100, and maps it into userspace.

### Pin CPU Switch
Switches exploit to CPU 1.

### Adjust Consumer RIngbuf Offset
Sets ringbuf consumer offset to 0x3000.

### Write Exploit Payload
Writes malicious function pointer and rop chain into writable wringbuf page for consumer position.
The function pointer is in a `irq_work` structure used for notifying waiting processes when new data is available. When this value is called, a pointer to data close by in the same writable page resides in `rbx`. So function pointer jumps to a stack pivot gadget similar to `push rbx; pop rsp`.

### Load eBPF Program
Loads the malicious eBPF program which will write into the ringbuffer and corrupt the header.
The eBPF program essentially makes 2 calls to reserve 0x3000 space in the ringbuffer. Because of the malicious consumer offset set by userspace, both succeed, and second overlap with first header. After corrupting header of first reservation, eBPF code then commits the first chunk, which goes down code path which uses malicious function pointer.

### Trigger Exploit with Socket
Creates a dummy unix domain socket, attaches the eBPF program, and sends 1 byte message to trigger exploit program to run.