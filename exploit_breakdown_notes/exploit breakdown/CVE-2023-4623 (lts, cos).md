# Bug
UAF of HFSC qdisc by creating some child classes and freeing them.

TODO: better understand the bug. I don't really fully what is a class and how they are arranged in a tree with qdiscs.

# Exploit Chain (lts)

### Pin CPU
Pins process to CPU 0.

### Leak KASLR
Uses CVE-2022-4543 sidechannel to leak KASLR base address.

### Create Namespace
Creates a new user and network namespace, to get CAP_NET_ADMIN.

### Setup Network Device
Sets up loopback device which vulnerable qdisc will be on.

### Trigger Vuln
After vuln is triggered, there is an HFSC qdisc in use but the underlying memory has been freed.

### Spray Fake HFSC Qdisc in Xattr Data
Spray many extended file attribute structs which have user controlled data, a partial fake HFSC Qdisc is in the data section to overwrite the original qdisc.

### Arbritrary Write to qfq_change_qdisc pointer
By replacing fields of the hfsc qdisc, next time it is used, an abritrary write will occur.
This overwrites a pointer in data section, to a jop gadget.
This pointer is called qfq_qdisc_ops.change, and it is called based on sending netlink packets. (I am not sure why they made this writable).

### Construct JOP / ROP chain
When JOP gadget called, rsi points in user controleld packet data. This jop chain pushes rsi on the stack then jumps to address stored relative to rsi.
This address is controlled, so it jumps to stack pivot gadget which pops old rsi into rsp, then rop chain payload is written at controlled packet data which rsi points to.
Rop chain itself is standard kernel rop chain change to root creds.

### Post ROP
Returns back to userspace process, which is now root. The process simply leaves the namespace, and spawns a root shell.