CVE-2023-20938 initially patched in February 2023 security bulletin (https://source.android.com/docs/security/bulletin/2023-02-01#kernel) by commit https://android.googlesource.com/kernel/common/+/ecf61e4e1117%5E%21/#F0 and others.
CVE-2023-21255 was patched in July 2023 security bulletin (https://source.android.com/docs/security/bulletin/2023-07-01#kernel) by commit https://android.googlesource.com/kernel/common/+/1ca1130ec62d.

# Running Custom Kernel

First used [common-android13-5.10-2023-01](https://android.googlesource.com/kernel/manifest/+/refs/heads/common-android13-5.10-2023-01) branch to try to reproduce exploit.
However, this branch actually has some commits from as late as July, which is after exploit was patched, and the patch is present.
Witched to use [common-android13-5.10-2022-06](https://android.googlesource.com/kernel/manifest/+/refs/heads/common-android13-5.10-2022-06) branch, since this one doesn't seem to have the patch.
Had to modify manifest to use common-modules/virtual-device with same commit as 2023-01 commit, since this version did not seem to support virtual device building target.
Used commit `423eb1c11b3ec94ab40900529c0bf7aca94cf4fa` for this.
Also have to specify commit `3767674eac6b05a31eb02f082433a3019b93b6fc` for kernel/common, since partial fix which makes exploit harder is applied after this commit.

Use command `HOME=$PWD ./bin/launch_cvd -kernel_path=../../android13-5.10-2023-01/Image -initramfs_path=../../android13-5.10-2023-01/initramfs.img -cpus 8` to run kernel.
```sh
HOME=$PWD ./bin/launch_cvd -kernel_path=../../android13-5.10-2022-06/Image -initramfs_path=../../android13-5.10-2022-06/initramfs.img -cpus 8
```

Use `LD_PRELOAD=/data/local/tmp/libbadnode.so sleep 1` to run exploit

# Debugging

Binder logs lots of things, which show up in `dmesg`. To get root in adb just run `su`
By default, only certain things are logged. There is a module paramater called `debug_mask`, which controls which things are logged.

```c
enum {  
       BINDER_DEBUG_USER_ERROR             = 1U << 0,  
       BINDER_DEBUG_FAILED_TRANSACTION     = 1U << 1,  
       BINDER_DEBUG_DEAD_TRANSACTION       = 1U << 2,  
       BINDER_DEBUG_OPEN_CLOSE             = 1U << 3,  
       BINDER_DEBUG_DEAD_BINDER            = 1U << 4,  
       BINDER_DEBUG_DEATH_NOTIFICATION     = 1U << 5,  
       BINDER_DEBUG_READ_WRITE             = 1U << 6,  
       BINDER_DEBUG_USER_REFS              = 1U << 7,  
       BINDER_DEBUG_THREADS                = 1U << 8,  
       BINDER_DEBUG_TRANSACTION            = 1U << 9,  
       BINDER_DEBUG_TRANSACTION_COMPLETE   = 1U << 10,  
       BINDER_DEBUG_FREE_BUFFER            = 1U << 11,  
       BINDER_DEBUG_INTERNAL_REFS          = 1U << 12,  
       BINDER_DEBUG_PRIORITY_CAP           = 1U << 13,  
       BINDER_DEBUG_SPINLOCKS              = 1U << 14,  
};  
static uint32_t binder_debug_mask = BINDER_DEBUG_USER_ERROR |  
       BINDER_DEBUG_FAILED_TRANSACTION | BINDER_DEBUG_DEAD_TRANSACTION;  
module_param_named(debug_mask, binder_debug_mask, uint, 0644);
```

To set it to log everything, run the following command:
```sh
echo 4294967295 | tee /sys/module/binder/parameters/debug_mask   
```