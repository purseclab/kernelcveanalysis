"""
analysis.exploitability — Heuristic + LLM exploitability classification.

Produces a ``ControlClassification`` and score for a given crash.
"""

from __future__ import annotations

from typing import Optional

from ..core.config import Config, load_config
from ..core.llm import LLMClient
from ..core.models import (
    Confidence,
    ControlClassification,
    CrashReport,
    RootCauseAnalysis,
    VulnType,
)

# ── Heuristic scoring ────────────────────────────────────────────────

_VULN_BASE_SCORES: dict[VulnType, int] = {
    VulnType.UAF: 70,
    VulnType.OOB_WRITE: 65,
    VulnType.DOUBLE_FREE: 60,
    VulnType.OOB_READ: 40,
    VulnType.RACE_CONDITION: 55,
    VulnType.TYPE_CONFUSION: 60,
    VulnType.INTEGER_OVERFLOW: 45,
    VulnType.USE_BEFORE_INIT: 35,
    VulnType.NULL_DEREF: 15,
    VulnType.LOGIC_BUG: 30,
    VulnType.UNKNOWN: 20,
}


def classify_exploitability(
    crash: CrashReport,
    root_cause: Optional[RootCauseAnalysis] = None,
    *,
    cfg: Optional[Config] = None,
) -> RootCauseAnalysis:
    """
    Classify exploitability of a crash.

    If a ``root_cause`` is provided, enriches it with exploitability fields.
    Otherwise creates a minimal ``RootCauseAnalysis`` with just the score.
    """
    if root_cause is None:
        root_cause = RootCauseAnalysis(
            vulnerability_type=crash.bug_type,
            vulnerable_function=crash.corrupted_function,
        )

    # Heuristic base score
    score = _VULN_BASE_SCORES.get(crash.bug_type, 20)

    # Bonus: write access
    if crash.access_type == "write":
        score += 10

    # Bonus: larger object → more overwrite headroom
    if crash.object_size and crash.object_size >= 64:
        score += 5

    # Bonus: known slab cache → easier heap shaping
    if crash.slab_cache:
        score += 5

    # Penalty: read-only access
    if crash.access_type == "read" and crash.bug_type in (VulnType.OOB_READ, VulnType.USE_BEFORE_INIT):
        score -= 10

    score = max(0, min(100, score))

    # Quick classification from score
    if score >= 80:
        ctrl = ControlClassification.ARBITRARY_KRW
    elif score >= 60:
        ctrl = ControlClassification.IP_CONTROL
    elif score >= 40:
        ctrl = ControlClassification.LIMITED_WRITE
    elif score >= 20:
        ctrl = ControlClassification.DATA_ONLY
    else:
        ctrl = ControlClassification.NONE

    root_cause.exploitability_score = score
    root_cause.control_classification = ctrl
    root_cause.confidence = (
        Confidence.HIGH if score >= 70
        else Confidence.MEDIUM if score >= 40
        else Confidence.LOW
    )

    return root_cause
