"""
exploit.primitives â€” Capability primitive registry.

Primitives are building blocks (e.g., "heap_spray_msg_msg",
"overwrite_cred") that come from analysis or external adapters.
"""

from __future__ import annotations

from typing import Dict, List, Optional

from ..core.models import Primitive


class PrimitiveRegistry:
    """Registry of capability primitives from all sources."""

    def __init__(self) -> None:
        self._primitives: Dict[str, Primitive] = {}

    def add(self, prim: Primitive) -> None:
        self._primitives[prim.name] = prim

    def get(self, name: str) -> Optional[Primitive]:
        return self._primitives.get(name)

    def list_all(self) -> List[Primitive]:
        return list(self._primitives.values())

    def list_by_category(self, category: str) -> List[Primitive]:
        return [p for p in self._primitives.values() if p.category == category]

    def capabilities(self) -> List[str]:
        """Return all unique capability strings across all primitives."""
        caps: set[str] = set()
        for prim in self._primitives.values():
            pc = prim.provides.get("caps", [])
            if isinstance(pc, str):
                pc = [pc]
            caps.update(pc)
        return sorted(caps)

    def merge(self, other: PrimitiveRegistry) -> None:
        """Merge another registry into this one."""
        for prim in other.list_all():
            self.add(prim)
