# Kexploit

Tool for automatic exploit adaptation between linux kernels.

## Setup

Install [uv](https://docs.astral.sh/uv/getting-started/installation/) python package / project manager to run.

Other tools are needed for certain functionality:
- [vmlinux-to-elf](https://github.com/marin-m/vmlinux-to-elf) for loading kernel images for exploit adaptation
- [android-ndk](https://github.com/purseclab/kernelcveanalysis/blob/main/exploit_breakdown_notes/Installing%20Android%20NDK.md) for compiling syzkall POCs to test on cuttlefish
  - You will also need to update `./compile.sh` file to point to android-ndk installation folder
- `syz-prog2c` binary from [syzkaller](https://github.com/google/syzkaller) to translate syz DSL pocs to C pocs for running on cuttlefish
  - place `syz-prog2c` binary in same current working directory you run kexploit in
- [ghidra](https://github.com/NationalSecurityAgency/ghidra) for analyzing kernels and adapting exploits between kernels
  - Point `GHIDRA_INSTALL_DIR` env variable to folder containing ghidra release downloaded from github (can be done in .env file)

### .env file

Certain environmant variables are needed fro certain functionallity, and they can be put in a .env file.

Example .env:

```
# OpenAI api key for automatic exploit annotation
OPENAI_API_KEY="REDACTED"
# Folder to store all kexploit data (syzkall artifacts, kernel binaries, ghidra data, etc) in
KEXPLOIT_DATA_DIR="/home/jack/Documents/college/purdue/research/kernelcveanalysis/kexploit/kexploit_data/"
# Folder containing ghidra release for exploit adaptation
GHIDRA_INSTALL_DIR="/home/jack/Documents/college/purdue/research/kernelcveanalysis/kexploit/ghidra_11.3.2_PUBLIC/"
```

### Setup for Running syzkaller POCs on Cuttlefish

Start the cuttlefish emulator on cuttlefish server, and run adb once to start adb daemon:
```sh
cd /home/jack/cuttlefish_images/aosp_android13_cgi/cf
HOME=$PWD ./bin/launch_cvd -kernel_path=/home/jack/ingots/kernel/Image -initramfs_path=/home/jack/ingots/kernel/initramfs.img
./bin/adb shell
```
The above command starts ingots kernel 5.10.101, but there are many different kernel versions on cuttlefish server.

Setup ssh port forwarding for adb on local machine running kexploit:
```sh
ssh -L localhost:5037:localhost:5037 cuttlefish-user@cuttlefish-host
```

`uv run kexploit test <bug_id>` can now be used to test syzkaller bugs.

## Running

In the kexploit folder, run `uv run kexploit` to run kexploit. There are various commands and subcommands that can be run (see `uv run kexploit --help` or `src/kexploit/main.py` for details).

### Kexploit Subcommands

#### Exploit Adaptation
- `uv run kexploit kernel list`: list imported kernels
- `uv run kexploit kernel add --name imported_kernel_name path/to/kernel/image`: import kernel image for exploit adaptation (may take a long time, around 10-15 minutes)
- `uv run kexploit annotate --kernel kernel_name exploit_file1.c exploit_file2.c`: automatically annotate exploit files
- `uv run kexploit adapt --old-kernel kernel_name --new-kernel kernel_name exploit_file1.c exploit_file2.c`: adapt annotated exploit from 1 kernel version to another

#### Syzkaller POC Reproduction
- `uv run kexploit syzkall pull`: pull exploits from syzkaller website and save locally
  - database with syzkall exploits metadata already created and pushed in github so this shouldn't be needed
- `uv run kexploit syzkall query`: query available POCs pulled from syzkaller website
  - kind of incomplete, I just wrote random code here and changed code itself when looking for different bugs
- `uv run kexploit syzkall test <bug_id>`: run the given bug on cuttlefish and reprot if crash occurred
  - see [here](#setup-for-running-syzkaller-pocs-on-cuttlefish) for neccessary setup for `kexploit test`
