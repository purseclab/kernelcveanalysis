from pathlib import Path
from typing import List, Optional, Tuple
from typing_extensions import Annotated
from difflib import unified_diff
import os

import typer

from kernel_image import KernelAdapter
from rewrite_rules import gen_rewrite_rules, apply_rewrites
from parse import lex, Token, Literal

app = typer.Typer()

@app.command()
def adapt(
    exploit_files: Annotated[List[Path], typer.Argument(help="C source code files of exploit to adapt")],
    old_kernel: Annotated[Path, typer.Option(help="Original kernel exploit was made for")],
    new_kernel: Annotated[Path, typer.Option(help="New kernel to adapt exploit to")],
    apply: Annotated[bool, typer.Option(help="Apply changes to exploit")] = False,
    o: Annotated[Path, typer.Option(help="Output file for exploit diff")] = Path("new_exploit.diff"),
):
    diff = ''

    adapter = KernelAdapter(old_kernel, new_kernel)
    rewrites = gen_rewrite_rules(adapter)

    for file in exploit_files:
        # if kexploit.h is globbed in exploit_files, ignore
        if os.path.basename(file) == 'kexploit.h':
            continue

        with open(file, 'r') as f:
            exploit_code = f.read()

        lexed_code = lex(exploit_code)
        new_code = apply_rewrites(rewrites, lexed_code)

        for diff_line in unified_diff(
            exploit_code.split('\n'),
            new_code.split('\n'),
            fromfile=str(file),
            tofile=str(file),
            lineterm='',
        ):
            diff += diff_line + '\n'
        
        if apply:
            with open(file, 'w') as f:
                f.write(new_code)

    print(diff)

    with open(o, 'w') as f:
        f.write(diff)

@app.command()
def annotate(
    exploit_files: Annotated[List[Path], typer.Argument(help="C source code files of exploit to annotate")],
):
    def do_annotate(tokens: List[Token], index: int) -> Optional[Tuple[int, str]]:
        match tokens[index]:
            case Literal(_, int(address)):
                # TODO: don't annotate if already annotated
                # TODO: use different kernel address base for x86
                if address & 0xffffffc000000000 == 0xffffffc000000000:
                    return 1, f'__kexploit_kernel_address({hex(address)})'
        
        return None

    diff = ''

    for file in exploit_files:
        # if kexploit.h is globbed in exploit_files, ignore
        if os.path.basename(file) == 'kexploit.h':
            continue

        with open(file, 'r') as f:
            exploit_code = f.read()
        
        lexed_code = lex(exploit_code)
        annotated_code = lexed_code.replace_tokens(do_annotate)

        # diff just for user
        for diff_line in unified_diff(
            exploit_code.split('\n'),
            annotated_code.split('\n'),
            fromfile=str(file),
            tofile=str(file),
            lineterm='',
        ):
            diff += diff_line + '\n'

        with open(file, 'w') as f:
            f.write(annotated_code)
    
    print(diff)
        
        

if __name__ == "__main__":
    app()
