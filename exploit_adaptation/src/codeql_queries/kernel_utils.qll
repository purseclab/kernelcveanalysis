import cpp
import semmle.code.cpp.dataflow.new.DataFlow

class FlexibleArrayMember extends Field {
  FlexibleArrayMember() {
    exists(Struct s |
      this = s.getCanonicalMember(max(int j | s.getCanonicalMember(j) instanceof Field | j))
    ) and
    this.getUnspecifiedType() instanceof ArrayType and
    (
      this.getUnspecifiedType().(ArrayType).getArraySize() <= 1 or
      not this.getUnspecifiedType().(ArrayType).hasArraySize()
    )
  }
}

// gets the type passed in to sizeof
Type sizeofParam(Expr e) {
  result = e.(SizeofExprOperator).getExprOperand().getFullyConverted().getType()
  or
  result = e.(SizeofTypeOperator).getTypeOperand()
}

// interface for both regular kmalloc calls and calls to a specific cache
abstract class KmallocCall extends FunctionCall {
  KmallocCall() { any() }

  abstract Expr getSizeArg();
  abstract Expr getFlagArg();
  // doesn't hold if no cache arg present
  abstract Expr getCacheNameArg();

  string getFlag() {
    result =
      concat(Expr flag |
        flag = this.getFlagArg().getAChild*() and flag.getValueText().matches("%GFP%")
      |
        flag.getValueText(), "|"
      )
  }

  string getSize() {
    if this.getSizeArg().isConstant()
    then result = this.getSizeArg().getValue()
    else result = "unknown"
  }

  Struct getStruct() {
    // get result from input sizeof argument
    exists(Expr sof |
      this.getSizeArg().getAChild*() = sof and
      sizeofParam(sof) = result
    ) or
    // get result from return type
    result = this.getFullyConverted().getType().stripType() 
  }

  string isFlexible() {
    this.getSize() = "unknown" and
    this.getStruct().getAField() instanceof FlexibleArrayMember and
    result = "true"
    or
    not this.getSize() = "unknown" and
    not this.getStruct().getAField() instanceof FlexibleArrayMember and
    result = "false"
  }

  string getCacheName() {
    if this.getCacheNameArg().isConstant()
    then result = this.getCacheNameArg().getValue()
    else result = "default"
  }
}

class SimpleKmallocCall extends KmallocCall {
  SimpleKmallocCall() { this.getTarget().hasName(["kmalloc", "kzalloc", "kvmalloc"]) }

  override Expr getSizeArg() { result = this.getArgument(0) }
  override Expr getFlagArg() { result = this.getArgument(1) }
  override Expr getCacheNameArg() { none() }
}

predicate isKmemCacheAllocCall(FunctionCall call) {
  call.getTarget().hasName(["kmem_cache_alloc", "kmem_cache_zalloc"])
}

class KmallocCache extends FunctionCall {
  KmallocCache() { this.getTarget().hasName(["kmem_cache_create"]) }

  Expr getNameArg() { result = this.getArgument(0) }

  string getName() { result = this.getNameArg().getValue() }

  Expr getSizeArg() { result = this.getArgument(1) }

  int getSize() { result = this.getSizeArg().getValue().toInt() }

  Expr getAlignArg() { result = this.getArgument(2) }

  int getAlign() { result = this.getAlignArg().getValue().toInt() }

  Expr getFlagsArg() { result = this.getArgument(3) }

  string getFlags() { result = this.getFlagsArg().getValue() }
}

module KmallocCacheFlowConfig implements DataFlow::ConfigSig {
  predicate isSource(DataFlow::Node source) {
    exists(KmallocCache cache |
      source.asIndirectExpr(1) = cache
    )
  }

  predicate isSink(DataFlow::Node sink) {
    exists(FunctionCall alloc |
      isKmemCacheAllocCall(alloc) and sink.asIndirectExpr(1) = alloc.getArgument(0)
    )
  }
}

module KmallocCacheFlow = DataFlow::Global<KmallocCacheFlowConfig>;

class KmallocCallWithCache extends KmallocCall {
  KmallocCache cache;

  KmallocCallWithCache() {
    isKmemCacheAllocCall(this)
    and
    exists(DataFlow::Node source, DataFlow::Node sink |
      source.asIndirectExpr(1) = cache
      and sink.asIndirectExpr(1) = this.getCacheNameArg()
    )
  }

  override Expr getSizeArg() { result = cache.getSizeArg() }
  override Expr getFlagArg() { result = this.getArgument(1) }
  override Expr getCacheNameArg() { result = cache.getNameArg() }
}