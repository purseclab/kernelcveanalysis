from typing import Optional
from pathlib import Path
import os
import shutil

from pydantic import BaseModel

from .kernel_image import Kernel
from .adapt import adapt, DiffMode

class ProjectMetadata(BaseModel):
    # TODO: maybe enforce no .. in paths?
    src_folder: str
    adapt_folder: str
    adapt_files: list[str]

class Project:
    project_path: Path
    metadata: ProjectMetadata

    def __init__(self, project_path: Path):
        self.project_path = project_path

        metadata_path = os.path.join(project_path, 'kexploit.json')
        with open(metadata_path, 'r') as f:
            self.metadata = ProjectMetadata.model_validate_json(f.read())
    
    def get_adaptation_folder(self) -> Path:
        adapt_folder = Path(os.path.join(self.project_path, self.metadata.adapt_folder))
        if not adapt_folder.exists():
            adapt_folder.mkdir()
        
        assert adapt_folder.is_dir()
    
    def copy_src_for_kernel(self, kernel: Kernel) -> Path:
        adapt_folder = os.path.join(self.project_path, self.metadata.adapt_folder)
        adapt_path = Path(os.path.join(adapt_folder, kernel.name))
        if adapt_path.exists():
            assert adapt_path.is_dir()
            shutil.rmtree(adapt_path)
        
        src_folder = Path(os.path.join(self.project_path, self.metadata.src_folder))
        shutil.copytree(src_folder, adapt_path)
        return adapt_path
    
    def adapt(self, kernel: Kernel):
        adapt_path = self.copy_src_for_kernel(kernel)
        adapt_file_paths = [Path(os.path.join(adapt_path, adapt_file)) for adapt_file in self.metadata.adapt_files]

        adapt(adapt_file_paths, None, kernel, None, DiffMode.APPLY_DIFF)

def find_project() -> Optional[Path]:
    folder = Path.cwd()
    while True:
        config = Path(os.path.join(folder, 'kexploit.json'))
        if config.exists():
            return folder
        
        # check if root
        if folder.parent == folder:
            return None
        
        folder = folder.parent

def adapt_project(project_path: Optional[Path], new_kernel: Kernel):
    if project_path is None:
        project_path = find_project()
    
    if project_path is None:
        print('Could not find `kexploit.json`')
        return
    
    project = Project(project_path)
    project.adapt(new_kernel)
