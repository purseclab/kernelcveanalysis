from enum import StrEnum
from pathlib import Path
from tempfile import TemporaryDirectory
from dataclasses import dataclass
from collections import defaultdict
import subprocess
import csv

from .location import Location

CODEQL_QUERY_FOLDER = Path(__file__).parent.parent.parent / 'codeql_queries'

class CodeqlQuery(StrEnum):
    KmallocCalls = 'allocations.ql'
    Structs = 'structs.ql'

@dataclass
class CodeQlStructResult:
    struct_name: str
    is_anon: bool
    field_names: list[str]
    location: Location

class CodeqlContext:
    database_path: Path
    query_folder: Path

    def __init__(self, database_path: Path, query_folder: Path = CODEQL_QUERY_FOLDER):
        self.database_path = database_path
        self.query_folder = query_folder
    
    def run_query_raw(self, query: CodeqlQuery) -> str:
        with TemporaryDirectory() as dir:
            query_path = self.query_folder / str(query)
            bqrs_path = dir + '/output.bqrs'
            csv_path = dir + '/output.csv'

            subprocess.run(
                ['codeql', 'query', 'run', str(query_path), '--database', str(self.database_path), '--output', bqrs_path],
                cwd=str(self.query_folder),
                check=True,
            )

            subprocess.run(
                ['codeql', 'bqrs', 'decode', bqrs_path, '--output', csv_path, '--format', 'csv']
            )

            with open(csv_path, 'r') as f:
                data = f.read()
        
        return data

    def run_query(self, query: CodeqlQuery):
        output = self.run_query_raw(query)
        reader = csv.reader(output.splitlines())
        # skip header line
        next(reader)
        return reader

    # run Structs query with parsing output
    def get_structs(self) -> list[CodeQlStructResult]:
        rows = self.run_query(CodeqlQuery.Structs)

        fields = defaultdict(dict)
        structs = []

        for row in rows:
            struct_name, is_anon, field_name, field_index, location_str = row

            location = Location.from_str(location_str)

            if struct_name not in fields:
                structs.append(CodeQlStructResult(
                    struct_name=struct_name,
                    is_anon=bool(int(is_anon)),
                    field_names=[],
                    location=location,
                ))

            fields[struct_name][field_index] = field_name
        
        for struct in structs:
            field_names = [(index, name) for index, name in fields[struct.struct_name].items()]
            field_names.sort(key=lambda info: info[0])
            struct.field_names = [name for _index, name in field_names]
        
        return structs

