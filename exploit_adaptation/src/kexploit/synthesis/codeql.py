from enum import StrEnum
from pathlib import Path
from tempfile import TemporaryDirectory
import subprocess

CODEQL_QUERY_FOLDER = Path(__file__).parent.parent.parent / 'codeql_queries'

class CodeqlQuery(StrEnum):
    KmallocCalls = 'allocations.ql'

class CodeqlContext:
    database_path: Path
    query_folder: Path

    def __init__(self, database_path: Path, query_folder: Path = CODEQL_QUERY_FOLDER):
        self.database_path = database_path
        self.query_folder = query_folder
    
    def run_query(self, query: CodeqlQuery) -> str:
        with TemporaryDirectory() as dir:
            query_path = self.query_folder / str(query)
            bqrs_path = dir + '/output.bqrs'
            csv_path = dir + '/output.csv'

            subprocess.run(
                ['codeql', 'query', 'run', str(query_path), '--database', str(self.database_path), '--output', bqrs_path],
                cwd=str(self.query_folder),
                check=True,
            )

            subprocess.run(
                ['codeql', 'bqrs', 'decode', bqrs_path, '--output', csv_path, '--format', 'csv']
            )

            with open(csv_path, 'r') as f:
                data = f.read()
        
        return data

