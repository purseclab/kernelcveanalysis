from dataclasses import dataclass
import hashlib
import re

@dataclass
class Location:
    file_path: str
    line_start: int
    col_start: int
    line_end: int
    col_end: int

    @classmethod
    def from_str(cls, s: str):
        # 1. Strip potential quotes if the CSV parser didn't catch them
        s = s.strip('"')
        
        # 2. Match: Optional file:// prefix, then path, then 4 colon-separated numbers
        # in docker source code is in src directory, so remove src as well
        pattern = r"^(?:file:///src/)?(.*?):(\d+):(\d+):(\d+):(\d+)$"
        match = re.match(pattern, s)
        
        if not match:
            # Fallback for unexpected formats
            return cls(file_path=s, line_start=0, col_start=0, line_end=0, col_end=0)
        
        path, l1, c1, l2, c2 = match.groups()
        
        return cls(
            file_path=path,
            line_start=int(l1),
            col_start=int(c1),
            line_end=int(l2),
            col_end=int(c2)
        )

    def __str__(self):
        """Full string representation for round-tripping data."""
        return f"{self.file_path}:{self.line_start}:{self.col_start}:{self.line_end}:{self.col_end}"
    
    def to_db_id(self) -> int:
        digest = hashlib.sha256(str(self).encode()).hexdigest()
        return int(digest, 16) & (2**63 - 1)