from typing import Self
from pathlib import Path

from pydantic import BaseModel

from ..kernel_image import Kernel

METADATA_FILE_NAME = 'metadata.json'

class SynthesisMetadata(BaseModel):
    # need to store as string for json serialization
    kernel_name: str
    vmlinux: Path
    codeql_db: Path
    linux_src: Path

    def kernel(self) -> Kernel:
        return Kernel(self.kernel_name)
    
    def data_path(self) -> Path:
        return self.kernel().synthesis_data_path()
    
    def compile_commands_path(self) -> Path:
        return self.data_path() / 'compile_commands.json'

    def save(self):
        metadata_path = self.kernel().synthesis_data_path() / METADATA_FILE_NAME
        metadata_path.write_text(self.model_dump_json(), 'utf-8')
    
    @classmethod
    def load_for_kernel(cls, kernel: Kernel) -> Self:
        metadata_path = kernel.synthesis_data_path() / METADATA_FILE_NAME
        return cls.model_validate_json(metadata_path.read_text('utf-8'))